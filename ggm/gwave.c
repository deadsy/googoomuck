//-----------------------------------------------------------------------------
/*

Goom Waves

A Goom Wave is a wave shape with the following segments:

1) A rising cos -pi to 0 curve (s0)
2) A flat piece at the top (f0)
3) A falling cos 0 to pi curve (s1)
4) A flat piece at the bottom (f1)

Shape is controller by two parameters:
duty = split the total period between s0,f0 and s1,f1
slope = split s0f0 and s1f1 beween slope and flat.

*/
//-----------------------------------------------------------------------------

#include <string.h>

#include "ggm.h"

#define DEBUG
#include "logging.h"

//-----------------------------------------------------------------------------

// The wave duty cycle goes from MID_MIN to 1.f - MID_MIN
#define TP_MIN 0.1f

// Put a limit on how fast the slope can rise.
#define S_MIN 0.1f

//-----------------------------------------------------------------------------

// generated by ./scripts/lut.py
#define GOOM_TABLE_BITS (6U)
#define GOOM_TABLE_SIZE (1U << 6)
static const uint32_t GOOM_TABLE_data[GOOM_TABLE_SIZE] = {
	0x3f800000U, 0x3f7fb10fU, 0x3f7ec46dU, 0x3f7d3aacU,
	0x3f7b14beU, 0x3f7853f8U, 0x3f74fa0bU, 0x3f710908U,
	0x3f6c835eU, 0x3f676bd8U, 0x3f61c598U, 0x3f5b941aU,
	0x3f54db31U, 0x3f4d9f02U, 0x3f45e403U, 0x3f3daef9U,
	0x3f3504f3U, 0x3f2beb4aU, 0x3f226799U, 0x3f187fc0U,
	0x3f0e39daU, 0x3f039c3dU, 0x3ef15aeaU, 0x3edae880U,
	0x3ec3ef15U, 0x3eac7cd4U, 0x3e94a031U, 0x3e78cfccU,
	0x3e47c5c2U, 0x3e164083U, 0x3dc8bd36U, 0x3d48fb30U,
	0x248d3132U, 0xbd48fb30U, 0xbdc8bd36U, 0xbe164083U,
	0xbe47c5c2U, 0xbe78cfccU, 0xbe94a031U, 0xbeac7cd4U,
	0xbec3ef15U, 0xbedae880U, 0xbef15aeaU, 0xbf039c3dU,
	0xbf0e39daU, 0xbf187fc0U, 0xbf226799U, 0xbf2beb4aU,
	0xbf3504f3U, 0xbf3daef9U, 0xbf45e403U, 0xbf4d9f02U,
	0xbf54db31U, 0xbf5b941aU, 0xbf61c598U, 0xbf676bd8U,
	0xbf6c835eU, 0xbf710908U, 0xbf74fa0bU, 0xbf7853f8U,
	0xbf7b14beU, 0xbf7d3aacU, 0xbf7ec46dU, 0xbf7fb10fU,
};

//-----------------------------------------------------------------------------

void gwave_gen(struct gwave *osc, float *out, size_t n) {
	unsigned int i;
	for (i = 0; i < n; i++) {
		// which portion of the goom wave are we in?
		if (osc->phase < osc->tp) {
			// we are in the s0/f0 portion
			uint32_t idx = __USAT((uint32_t) (osc->phase * osc->k0), GOOM_TABLE_BITS);
			out[i] = osc->table[idx];
		} else {
			// we are in the s1/f1 portion
			uint32_t idx = __USAT((uint32_t) ((osc->phase - osc->tp) * osc->k1), GOOM_TABLE_BITS);
			out[i] = -osc->table[idx];
		}
		// step the phase
		osc->phase += osc->phase_step;
		if (osc->phase > 1.f) {
			osc->phase -= 1.f;
		}
	}
}

//-----------------------------------------------------------------------------

// Initialise a Goom wave.
// duty = duty cycle [0..1]
// slope = slope [0..1]
void gwave_init(struct gwave *osc, float duty, float slope) {
	float s;

	memset(osc, 0, sizeof(struct gwave));

	// setup the table
	osc->table = (float *)GOOM_TABLE_data;

	// This is where we transition from s0f0 to s1f1.
	duty = clamp(duty, 0.f, 1.f);
	osc->tp = TP_MIN + (1.f - 2.f * TP_MIN) * duty;

	// Work out the portion of s0f0/s1f1 that is sloped.
	slope = clamp(slope, 0.f, 1.f);
	s = S_MIN + (1.f - S_MIN) * slope;

	// scaling constant for s0, map the slope to the LUT.
	osc->k0 = (float)GOOM_TABLE_SIZE / (osc->tp * s);

	// scaling constant for s1, map the slope to the LUT.
	osc->k1 = (float)GOOM_TABLE_SIZE / ((1.f - osc->tp) * s);

}

//-----------------------------------------------------------------------------
